{% extends "base.html" %}
{% load tag_library %}
{% block content %}
<p>TalkList</p>

<div class='container'>
    <div class='row'>
        <div class='col-9' id="talks">
            <table class='table'>
                <tr>
                    <th>Status</th>
                    <th>Sender</th>
                    <th>Favorite</th>
                    <th>NewMessage</th>
                    <th>Limit</th>
                </tr>

                <!-- <div>未確認の終了トーク</div> -->
                {% for talk in unchecked_dead_talks %}
                <tr>
                    <td>End and Unconfirmed</td><!--ステータス-->
                    <!-- 自分がメッセージを送った時 -->
                    {% if talk.sending_user == user %}

                        {% if talk.exist_reply == True %}
                            <!--返信があれば相手の名前（詳細へのリンク）といいねボタンを表示-->
                            <td><!--相手-->
                                <a href="{% url 'postapp:talk_detail' talk_id=talk.id %}">{{talk.receiving_user}}</a>
                            </td>
                            <td><!--いいね-->
                                {% favorite_check user talk as flag %}
                                {% if flag %}
                                <a href="{% url 'postapp:talk_favorite_delete' talk_id=talk.id %}">Delete Favorite</a>
                                {% else %}
                                <a href="{% url 'postapp:talk_favorite_add' talk_id=talk.id %}">Add Favorite</a>
                                {% endif %}
                            </td>
                        {% else %}
                            <!--返信がなければ相手の名前のみ表示-->
                            <td><!--相手-->
                                {{talk.receiving_user}}
                            </td>
                            <td></td><!--いいね-->
                        {% endif %}

                    <!-- 相手からメッセージが来た時 -->
                    {% else %}
                        <td><!--相手-->
                            <a href="{% url 'postapp:talk_detail' talk_id=talk.id %}">{{talk.sending_user}}</a>
                        </td>
                        <td><!--いいね-->
                            {% favorite_check user talk as flag %}
                            {% if flag %}
                            <a href="{% url 'postapp:talk_favorite_delete' talk_id=talk.id %}">Delete Favorite</a>
                            {% else %}
                            <a href="{% url 'postapp:talk_favorite_add' talk_id=talk.id %}">Add Favorite</a>
                            {% endif %}
                        </td>
                    {% endif %}
                    <td>{% get_newest_message talk.id %}</td>
                    {% integer_to_string talk.id as flag %}
                    <td><p class="time" id={{flag}}>残り時間</p></td>
                    <input class="lefttime" type="hidden" id={{flag}} value={{talk.created_at|date:"Y-m-d_H:i:sO"}}>                </tr>
                {% endfor %}

                <!-- <div>未読トーク</div> -->
                {% for talk in unread_talks %}
                <tr>
                    <td>Unread</td><!--ステータス-->
                    <!-- 自分がメッセージを送った時 -->
                    {% if talk.sending_user == user %}

                        {% if talk.exist_reply == True %}
                            <!--返信があれば詳細へのリンクといいねボタンを表示-->
                            <td><!--相手-->
                                <a href="{% url 'postapp:talk_detail' talk_id=talk.id %}">{{talk.receiving_user}}</a>
                            </td>
                            <td><!--いいね-->
                                {% favorite_check user talk as flag %}
                                {% if flag %}
                                <a href="{% url 'postapp:talk_favorite_delete' talk_id=talk.id %}">Delete Favorite</a>
                                {% else %}
                                <a href="{% url 'postapp:talk_favorite_add' talk_id=talk.id %}">Add Favorite</a>
                                {% endif %}
                            </td>
                        {% else %}
                        <!--返信がなければ相手の名前のみ表示-->
                            <td><!--相手-->
                                {{talk.receiving_user}}
                            </td>
                            <td></td><!--いいね-->
                        {% endif %}

                    <!-- 相手からメッセージが来た時 -->
                    {% else %}
                        <td><!--相手-->
                            <a href="{% url 'postapp:talk_detail' talk_id=talk.id %}">{{talk.sending_user}}</a>
                        </td>
                        <td><!--いいね-->
                            {% favorite_check user talk as flag %}
                            {% if flag %}
                            <a href="{% url 'postapp:talk_favorite_delete' talk_id=talk.id %}">Delete Favorite</a>
                            {% else %}
                            <a href="{% url 'postapp:talk_favorite_add' talk_id=talk.id %}">Add Favorite</a>
                            {% endif %}
                        </td>
                    {% endif %}
                    <td>{% get_newest_message talk.id %}</td>
                    {% integer_to_string talk.id as flag %}
                    <td><p class="time" id={{flag}}>残り時間</p></td>
                    <input class="lefttime" type="hidden" id={{flag}} value={{talk.created_at|date:"Y-m-d_H:i:sO"}}>                </tr>
                {% endfor %}

                <!-- <div>既読トーク</div> -->
                {% for talk in read_talks %}
                <tr>
                    <td>Already read</td>
                    <!-- 自分がメッセージを送った時 -->
                    {% if talk.sending_user == user %}

                        {% if talk.exist_reply == True %}
                            <!--返信があれば詳細へのリンクといいねボタンを表示-->
                            <td><!--相手-->
                                <a href="{% url 'postapp:talk_detail' talk_id=talk.id %}">{{talk.receiving_user}}</a>
                            </td>
                            <td><!--いいね-->
                                {% favorite_check user talk as flag %}
                                {% if flag %}
                                <a href="{% url 'postapp:talk_favorite_delete' talk_id=talk.id %}">Delete Favorite</a>
                                {% else %}
                                <a href="{% url 'postapp:talk_favorite_add' talk_id=talk.id %}">Add Favorite</a>
                                {% endif %}
                            </td>
                        {% else %}
                            <!--返信がなければ相手の名前のみ表示-->
                            <td><!--相手-->
                                {{talk.receiving_user}}
                            </td>
                            <td></td><!--いいね-->
                    {% endif %}

                    <!-- 相手からメッセージが来た時 -->
                    {% else %}
                        <td><!--相手-->
                            <a href="{% url 'postapp:talk_detail' talk_id=talk.id %}">{{talk.sending_user}}</a>
                        </td>
                        <td><!--いいね-->
                            {% favorite_check user talk as flag %}
                            {% if flag %}
                            <a href="{% url 'postapp:talk_favorite_delete' talk_id=talk.id %}">Delete Favorite</a>
                            {% else %}
                            <a href="{% url 'postapp:talk_favorite_add' talk_id=talk.id %}">Add Favorite</a>
                            {% endif %}
                        </td>
                    {% endif %}
                    <td>{% get_newest_message talk.id %}</td>
                    {% integer_to_string talk.id as flag %}
                    <td><p class="time" id={{flag}}>残り時間</p></td>
                    <input class="lefttime" type="hidden" id={{flag}} value={{talk.created_at|date:"Y-m-d_H:i:sO"}}>                </tr>
                {% endfor %}

                <!-- <div>お気に入りした終了トーク</div> -->
                {% for talk in favorite_dead_talks %}
                <tr>
                    <td>End and Favorite</td>
                    <!-- 自分がメッセージを送った時 -->
                    {% if talk.sending_user == user %}

                        {% if talk.exist_reply == True %}
                            <!--返信があれば詳細へのリンクといいねボタンを表示-->
                            <td><!--相手-->
                                <a href="{% url 'postapp:talk_detail' talk_id=talk.id %}">{{talk.receiving_user}}</a>
                            </td>
                            <td><!--いいね-->
                                {% favorite_check user talk as flag %}
                                {% if flag %}
                                <a href="{% url 'postapp:talk_favorite_delete' talk_id=talk.id %}">Delete Favorite</a>
                                {% else %}
                                <a href="{% url 'postapp:talk_favorite_add' talk_id=talk.id %}">Add Favorite</a>
                                {% endif %}
                            </td>
                        {% else %}
                            <!--返信がなければ相手の名前のみ表示-->
                            <td><!--相手-->
                                {{talk.receiving_user}}
                            </td>
                            <td></td><!--いいね-->
                    {% endif %}

                    <!-- 相手からメッセージが来た時 -->
                    {% else %}
                        <td><!--相手-->
                            <a href="{% url 'postapp:talk_detail' talk_id=talk.id %}">{{talk.sending_user}}</a>
                        </td>
                        <td><!--いいね-->
                            {% favorite_check user talk as flag %}
                            {% if flag %}
                            <a href="{% url 'postapp:talk_favorite_delete' talk_id=talk.id %}">Delete Favorite</a>
                            {% else %}
                            <a href="{% url 'postapp:talk_favorite_add' talk_id=talk.id %}">Add Favorite</a>
                            {% endif %}
                        </td>
                    {% endif %}
                    <td>{% get_newest_message talk.id %}</td>
                    {% integer_to_string talk.id as flag %}
                    <td><p class="time" id={{flag}}>残り時間</p></td>
                    <input class="lefttime" type="hidden" id={{flag}} value={{talk.created_at|date:"Y-m-d_H:i:sO"}}>
                </tr>
                {% endfor %}
            </table>        </div>
        <div class='col-3' id="talks-time_limit">
        </div>
    </div>
</div>

<div style="margin-top:80px;">
    -----------------------------------------↓ デバッグ用　全てのトーク一覧　↓-------------------------------------------------
</div>

<div class='row'>
    <div class='col-6' id="talks">
        {% for talk in my_talks %}
        <p>
            {% if talk.sending_user == user %}
            {% if talk.exist_reply == True %}

            <a href="{% url 'postapp:talk_detail' talk_id=talk.id %}">{{talk.receiving_user}}</a>
            {% favorite_check user talk as flag %}
            {% if flag %}
            <span><a href="{% url 'postapp:talk_favorite_delete' talk_id=talk.id %}">Delete Favorite</a></span>
            {% else %}
            <span><a href="{% url 'postapp:talk_favorite_add' talk_id=talk.id %}">Add Favorite</a></span>
            {% endif %}
            {% else %}

            {{talk.receiving_user}}:返信待ち
            {% endif %}
            {% else %}
            <a href="{% url 'postapp:talk_detail' talk_id=talk.id %}">{{talk.sending_user}}</a>
            {% favorite_check user talk as flag %}
            {% if flag %}
            <span><a href="{% url 'postapp:talk_favorite_delete' talk_id=talk.id %}">Delete Favorite</a></span>
            {% else %}
            <span><a href="{% url 'postapp:talk_favorite_add' talk_id=talk.id %}">Add Favorite</a></span>
            {% endif %}
            {% endif %}
            <span> : {{talk.created_at}}</span>
        </p>
        {% endfor %}
    </div>
    <div class='col-6' id="talks-time_limit">
    </div>
</div>





<script>

    /*
    const data = JSON.parse('{{ data_json|safe }}');

    function init_display() {
        for (let d in data) {
            var newElement = document.createElement("p"); // p要素作成
            newElement.setAttribute("id", "talk" + d); // p要素にidを設定

            var parentDiv = document.getElementById("talks-time_limit");
            parentDiv.insertBefore(newElement, parentDiv.lastChild);
        }
    }
    */

    function update_time() {
        let nowTime = new Date();
        let limit_date = new Date(days = 14)

        const get_date = document.getElementsByClassName('lefttime');
        console.log("---------");
        console.log(get_date[1].getAttribute('value'));

        for (let d of get_date) {
            let created_at = new Date(d.getAttribute('value').replace("_","T"))
            created_at.setDate(created_at.getDate() + 14);
            let left_time = (created_at - nowTime) / 1000

            let daysLeft = Math.floor(left_time / (24 * 60 * 60));
            let hoursLeft = (Math.floor(left_time / (60 * 60))) % 24;
            let minitesLeft = (Math.floor(left_time / 60)) % 60;
            let secondsLeft = Math.floor(left_time) % 60;
            // 二桁表示
            minitesLeft = ("0" + minitesLeft).slice(-2)
            secondsLeft = ("0" + secondsLeft).slice(-2)
            // 出力
            console.log(typeof(d.id))

            document.querySelector("#"+d.id).innerHTML = (daysLeft + "d " + hoursLeft + "h " + minitesLeft + "m " + secondsLeft + "s ");
        }
    }
    /*
    init_display();
    */
    update_time();

    setInterval(update_time, 1000)

</script>

{% endblock %}
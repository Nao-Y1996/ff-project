{% extends "base.html" %}
{% load tag_library %}
{% block content %}
<p>トーク一覧</p>

<div class='container'>

    <div class='row'>
        <div class='col-6' id="talks">
            <div>未確認の終了トーク</div>
            {% for talk in unchecked_dead_talks %}
            <p>
                {% if talk.sending_user == user %}
                {% if talk.exist_reply == True %}

                <a href="{% url 'postapp:talk_detail' talk_id=talk.id %}">{{talk.receiving_user}}</a>
                {% favorite_check user talk.id as flag %}
                {% if flag %}
                <span><a href="{% url 'postapp:talk_favorite_delete' talk_id=talk.id %}">Delete Favorite</a></span>
                {% else %}
                <span><a href="{% url 'postapp:talk_favorite_add' talk_id=talk.id %}">Add Favorite</a></span>
                {% endif %}
                {% else %}

                {{talk.receiving_user}}:返信待ち
                {% endif %}
                {% else %}
                <a href="{% url 'postapp:talk_detail' talk_id=talk.id %}">{{talk.sending_user}}</a>
                {% favorite_check user talk.id as flag %}
                {% if flag %}
                <span><a href="{% url 'postapp:talk_favorite_delete' talk_id=talk.id %}">Delete Favorite</a></span>
                {% else %}
                <span><a href="{% url 'postapp:talk_favorite_add' talk_id=talk.id %}">Add Favorite</a></span>
                {% endif %}
                {% endif %}
                <span> : {{talk.created_at}}</span>
            </p>
            {% endfor %}
            <div>未読トーク</div>
            {% for talk in unread_talks %}
            <p>
                {% if talk.sending_user == user %}
                {% if talk.exist_reply == True %}

                <a href="{% url 'postapp:talk_detail' talk_id=talk.id %}">{{talk.receiving_user}}</a>
                {% favorite_check user talk.id as flag %}
                {% if flag %}
                <span><a href="{% url 'postapp:talk_favorite_delete' talk_id=talk.id %}">Delete Favorite</a></span>
                {% else %}
                <span><a href="{% url 'postapp:talk_favorite_add' talk_id=talk.id %}">Add Favorite</a></span>
                {% endif %}
                {% else %}

                {{talk.receiving_user}}:返信待ち
                {% endif %}
                {% else %}
                <a href="{% url 'postapp:talk_detail' talk_id=talk.id %}">{{talk.sending_user}}</a>
                {% favorite_check user talk.id as flag %}
                {% if flag %}
                <span><a href="{% url 'postapp:talk_favorite_delete' talk_id=talk.id %}">Delete Favorite</a></span>
                {% else %}
                <span><a href="{% url 'postapp:talk_favorite_add' talk_id=talk.id %}">Add Favorite</a></span>
                {% endif %}
                {% endif %}
                <span> : {{talk.created_at}}</span>
            </p>
            {% endfor %}
            <div>既読トーク</div>
            {% for talk in read_talks %}
            <p>
                {% if talk.sending_user == user %}
                {% if talk.exist_reply == True %}

                <a href="{% url 'postapp:talk_detail' talk_id=talk.id %}">{{talk.receiving_user}}</a>
                {% favorite_check user talk.id as flag %}
                {% if flag %}
                <span><a href="{% url 'postapp:talk_favorite_delete' talk_id=talk.id %}">Delete Favorite</a></span>
                {% else %}
                <span><a href="{% url 'postapp:talk_favorite_add' talk_id=talk.id %}">Add Favorite</a></span>
                {% endif %}
                {% else %}

                {{talk.receiving_user}}:返信待ち
                {% endif %}
                {% else %}
                <a href="{% url 'postapp:talk_detail' talk_id=talk.id %}">{{talk.sending_user}}</a>
                {% favorite_check user talk.id as flag %}
                {% if flag %}
                <span><a href="{% url 'postapp:talk_favorite_delete' talk_id=talk.id %}">Delete Favorite</a></span>
                {% else %}
                <span><a href="{% url 'postapp:talk_favorite_add' talk_id=talk.id %}">Add Favorite</a></span>
                {% endif %}
                {% endif %}
                <span> : {{talk.created_at}}</span>
            </p>
            {% endfor %}
        </div>
        <div class='col-6' id="talks-time_limit">
        </div>
    </div>
    <div class='row'>
        <div class='col-6' id="talks">
            {% for talk in my_talks %}
            <p>
                {% if talk.sending_user == user %}
                {% if talk.exist_reply == True %}

                <a href="{% url 'postapp:talk_detail' talk_id=talk.id %}">{{talk.receiving_user}}</a>
                {% favorite_check user talk.id as flag %}
                {% if flag %}
                <span><a href="{% url 'postapp:talk_favorite_delete' talk_id=talk.id %}">Delete Favorite</a></span>
                {% else %}
                <span><a href="{% url 'postapp:talk_favorite_add' talk_id=talk.id %}">Add Favorite</a></span>
                {% endif %}
                {% else %}

                {{talk.receiving_user}}:返信待ち
                {% endif %}
                {% else %}
                <a href="{% url 'postapp:talk_detail' talk_id=talk.id %}">{{talk.sending_user}}</a>
                {% favorite_check user talk.id as flag %}
                {% if flag %}
                <span><a href="{% url 'postapp:talk_favorite_delete' talk_id=talk.id %}">Delete Favorite</a></span>
                {% else %}
                <span><a href="{% url 'postapp:talk_favorite_add' talk_id=talk.id %}">Add Favorite</a></span>
                {% endif %}
                {% endif %}
                <span> : {{talk.created_at}}</span>
            </p>
            {% endfor %}
        </div>
        <div class='col-6' id="talks-time_limit">
        </div>
    </div>
</div>




<script>
    const data = JSON.parse('{{ data_json|safe }}');

    function init_display() {
        for (let d in data) {
            var newElement = document.createElement("p"); // p要素作成
            newElement.setAttribute("id", "talk" + d); // p要素にidを設定

            var parentDiv = document.getElementById("talks-time_limit");
            parentDiv.insertBefore(newElement, parentDiv.lastChild);
        }
    }

    function update_time() {
        let nowTime = new Date();
        let limit_date = new Date(days = 14)
        for (let d in data) {
            let created_at = new Date(data[d])
            created_at.setDate(created_at.getDate() + 14);
            let left_time = (created_at - nowTime) / 1000

            let daysLeft = Math.floor(left_time / (24 * 60 * 60));
            let hoursLeft = (Math.floor(left_time / (60 * 60))) % 24;
            let minitesLeft = (Math.floor(left_time / 60)) % 60;
            let secondsLeft = Math.floor(left_time) % 60;
            // 二桁表示
            minitesLeft = ("0" + minitesLeft).slice(-2)
            secondsLeft = ("0" + secondsLeft).slice(-2)
            // 出力
            document.querySelector("#talk" + d).innerHTML = ("残り時間は" + daysLeft + "日" + hoursLeft + "時間" + minitesLeft + "分" + secondsLeft + "秒です");
        }
    }
    init_display();
    update_time();

    setInterval(update_time, 1000)

</script>

{% endblock %}